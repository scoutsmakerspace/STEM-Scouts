name: Auto-update badges index + icons

on:
  push:
    branches: ["main"]
    paths:
      - "_badges/**"
      - "_data/badges_catalog.yml"
      - "assets/images/uploads/**"
      - "assets/images/badges/**"
      - "admin/config.yml"
      - "tools/generate_badges_master.py"
      - "tools/normalise_badge_icons.py"
      - "tools/sync_badges_from_catalog.py"
      - "tools/prune_retired_badges.py"
      - "tools/generate_stem_badge_map.py"
      - ".github/workflows/badges-autogen.yml"
  workflow_dispatch:

# prevent two runs racing to push
concurrency:
  group: badges-autogen-main
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  autogen:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml pillow

      - name: Sync badges from catalog (creates/updates _badges/*.md)
        run: |
          python tools/sync_badges_from_catalog.py

      - name: Normalise uploaded icons into canonical badge icons (also generates 64px)
        run: |
          python tools/normalise_badge_icons.py

      - name: Prune retired badges from mapping + activities
        run: |
          python tools/prune_retired_badges.py

      - name: Regenerate stem_badge_map.json + index
        run: |
          python tools/generate_stem_badge_map.py

      - name: Generate badges_master.json
        run: |
          python tools/generate_badges_master.py

      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Auto-update badges index + icons" || true

            # Avoid non-fast-forward if main moved while job was running
            git fetch origin main
            git pull --rebase origin main

            git push origin HEAD:main || (sleep 3 && git push origin HEAD:main)
          else
            echo "No changes to commit."
          fi
