{% assign items = include.items %}

{%- comment -%}
Add badge metadata for filtering and search.
- data-badges: pipe-separated badge IDs (for filtering)
- data-badge-text: badge titles + selected requirement text (for search)
{%- endcomment -%}

<div class="activity-index" role="list">
  {% for a in items %}
    {%- assign badge_ids = "" -%}
    {%- assign badge_search = "" -%}
    {%- if a.badge_links and a.badge_links.size > 0 -%}
      {%- for bl in a.badge_links -%}
        {%- assign bid = bl.badge_id | default: "" -%}
        {%- if bid != "" -%}
          {%- assign badge_ids = badge_ids | append: bid -%}
          {%- unless forloop.last -%}{%- assign badge_ids = badge_ids | append: "|" -%}{%- endunless -%}

          {%- assign badge_obj = site.data.badges_master | where: "id", bid | first -%}
          {%- assign badge_name = "" -%}
          {%- if badge_obj and badge_obj.badge_name -%}
            {%- assign badge_name = badge_obj.badge_name -%}
          {%- elsif bl.badge_title -%}
            {%- assign badge_name = bl.badge_title -%}
          {%- else -%}
            {%- assign badge_name = bid -%}
          {%- endif -%}

          {%- assign badge_search = badge_search | append: " " | append: badge_name -%}

          {%- if badge_obj and bl.requirements_met and bl.requirements_met.size > 0 -%}
            {%- for rid in bl.requirements_met -%}
              {%- assign req = badge_obj.requirements | where: "id", rid | first -%}
              {%- if req and req.text -%}
                {%- assign badge_search = badge_search | append: " " | append: req.text -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    <article class="activity-index__item" role="listitem"
      data-title="{{ a.title | downcase | escape }}"
      data-summary="{{ a.summary | default: '' | downcase | escape }}"
      data-badges="{{ badge_ids | escape }}"
      data-badge-text="{{ badge_search | downcase | escape }}"
      data-time="{{ a.time_minutes | default: '' }}"
      data-difficulty="{{ a.difficulty | default: '' }}"
      data-location="{{ a.location | default: '' | downcase }}"
      data-type="{{ a.type | default: '' | downcase }}"
      data-supervision="{{ a.supervision | default: '' | downcase }}"
    >
      <h3 class="activity-index__title">
        <a href="{{ a.url | relative_url }}">{{ a.title }}</a>
      </h3>

      <div class="activity-index__meta">
        {% if a.sections and a.sections.size > 0 %}
          <span class="meta-chip">
            Sections:
            {% for s in a.sections %}
              {{ s | downcase | capitalize }}{% unless forloop.last %}, {% endunless %}
            {% endfor %}
          </span>
        {% endif %}

        {% if a.difficulty %}<span class="meta-chip">Difficulty: {{ a.difficulty }}</span>{% endif %}
        {% if a.time_minutes %}<span class="meta-chip">Time: {{ a.time_minutes }} min</span>{% endif %}
        {% if a.type %}<span class="meta-chip">Type: {{ a.type }}</span>{% endif %}
        {% if a.location %}<span class="meta-chip">Location: {{ a.location }}</span>{% endif %}
        {% if a.supervision %}<span class="meta-chip">Supervision: {{ a.supervision }}</span>{% endif %}
      </div>

      {% if a.summary %}
        <p class="activity-index__summary">{{ a.summary }}</p>
      {% endif %}
    </article>
  {% endfor %}
</div>
