{% assign items = include.items %}

<div class="ra-search">
  <label class="ra-search__label" for="raSearch">Search risk assessments</label>
  <input id="raSearch" class="ra-search__input" type="search" placeholder="Type to filter (e.g. soldering, Cubs, review)..." autocomplete="off">
  <div id="raSearchCount" class="ra-search__count" aria-live="polite"></div>
</div>

<div class="ra-cards" id="raCards">
  {% for r in items %}
    {% capture ra_text %}
      {{ r.title }}
      {% if r.activity_name_location %} {{ r.activity_name_location }}{% endif %}
      {% if r.sections %} {{ r.sections | join: " " }}{% endif %}
      {% if r.next_review %} {{ r.next_review }}{% endif %}
    {% endcapture %}


    <article class="ra-card" data-ra-text="{{ ra_text | strip | downcase | escape }}">
      <h3 class="ra-card__title">
        <a href="{{ r.url | relative_url }}">{{ r.title }}</a>
      </h3>

      <div class="ra-card__meta">
        {% if r.sections and r.sections.size > 0 %}
          <span class="ra-chip">
            Applies to:
            {% for s in r.sections %}
              {{ s | downcase | capitalize }}{% unless forloop.last %}, {% endunless %}
            {% endfor %}
          </span>
        {% endif %}

        {% if r.next_review %}
          <span class="ra-chip">
            Next review: {{ r.next_review }}
          </span>
        {% endif %}
      </div>
    </article>
  {% endfor %}
</div>

<script>
(function () {
  var input = document.getElementById('raSearch');
  var cardsWrap = document.getElementById('raCards');
  var countEl = document.getElementById('raSearchCount');
  if (!input || !cardsWrap) return;

  var cards = Array.prototype.slice.call(cardsWrap.querySelectorAll('.ra-card'));

  function updateCount(visible, total) {
    if (!countEl) return;
    countEl.textContent = (visible === total)
      ? (total + " shown")
      : (visible + " of " + total + " shown");
  }

  function filter() {
    var q = (input.value || "").trim().toLowerCase();
    var tokens = q ? q.split(/\s+/).filter(Boolean) : [];

    var visible = 0;

    cards.forEach(function(card){
      var hay = card.getAttribute('data-ra-text') || "";
      var show = (tokens.length === 0) || tokens.every(function(t){ return hay.indexOf(t) !== -1; });

      card.style.display = show ? "" : "none";
      if (show) visible++;
    });

    updateCount(visible, cards.length);
  }

  input.addEventListener('input', filter);

  // initial
  filter();
})();
</script>

